# Taxi Backend Integration Notes

These notes summarize how the Flutter client should communicate with the `taxi-back` FastAPI service that lives next to this app (`../taxi-back`). All paths below are relative to the backend base URL defined in `lib/src/core/backend_config.dart`.

---

## 1. Base hosts

| Purpose | URL | Notes |
| --- | --- | --- |
| Default base (env `BACKEND_BASE_URL`) | `http://164.90.229.192` | change via `--dart-define BACKEND_BASE_URL=<url>` |
| REST root | `${backendBaseUrl}/api` | every route imported in `main.py` hangs off `/api` |
| WebSocket root | `${backendBaseUrl.replaceScheme(ws/wss)}/ws` | append `/driver/{token}` or `/user/{token}` |
| Swagger docs | `${backendBaseUrl}/docs` | auto generated by FastAPI |
| Health check | `${backendBaseUrl}/health` | simple uptime probe |
| Uploaded files | `${backendBaseUrl}/uploads/...` | profile & license images |

> `replaceScheme(ws/wss)` = `ws` when backend is `http`, `wss` when backend is `https`.

---

## 2. Authentication & session flow

1. **Register** `POST /api/auth/register` with `{telephone, name, password, confirm_password}`.
2. **Login** `POST /api/auth/login` with `{telephone, password}`.
3. Store `access_token` from response and send it as `Authorization: Bearer <token>` on every protected call.
4. Use `GET /api/auth/me` (or `/api/auth/profile`) to rehydrate the user.
5. Tokens are long lived (30 days by default) and there is no refresh endpoint—logout simply drops the token locally.

Roles come from `app/models.py`: `user`, `driver`, `admin`, `superadmin`. A user becomes a driver when:

1. They submit `/api/driver/apply`.
2. An admin approves the application through `/api/admin/driver-applications/review`.
3. The backend sets the user role to `driver` and emits a WebSocket `driver_status` event (see section 5).

---

## 3. Key REST surfaces

### 3.1 Regions & pricing
| Method | Path | Notes |
| --- | --- | --- |
| GET | `/api/regions/` | list regions (includes Uzbek latin/cyrillic & Russian names) |
| GET | `/api/regions/{region_id}/districts` | list districts lazily when not embedded |
| GET | `/api/regions/pricing` | accepts `from_region_id`, `to_region_id`, `service_type` |

### 3.2 Passenger orders
| Method | Path | Description |
| --- | --- | --- |
| POST | `/api/taxi-orders/` | create taxi request, backend computes price/service fee |
| POST | `/api/delivery-orders/` | create delivery request (item type, sender/receiver phones) |
| GET | `/api/taxi-orders/` | current user’s taxi orders, optional `status_filter` (`pending`, `accepted`, `completed`, `cancelled`) |
| GET | `/api/delivery-orders/` | same for delivery |
| GET | `/api/taxi-orders/{id}` | load details (accessible to owner or assigned driver) |
| POST | `/api/taxi-orders/cancel` | `{order_id, order_type, cancellation_reason}` |

The payload format lines up with `app/schemas.py` (`TaxiOrderCreate`, `DeliveryOrderCreate`). Dates expect `dd.MM.yyyy`, time is `HH:mm`.

### 3.3 Driver endpoints
| Method | Path | Description |
| --- | --- | --- |
| POST | `/api/driver/apply` | create application after uploading license | 
| POST | `/api/driver/upload-license` | multipart upload helper (returns `uploads/licenses/<file>` path) |
| GET | `/api/driver/status` | tells whether current user is a driver, includes `driver_id`, `status`, and pending application info |
| GET | `/api/driver/statistics` | aggregates (daily/monthly/total orders + revenue, current balance, rating) |
| GET | `/api/driver/orders/new` | feed of pending taxi + delivery orders, supports `from_region_id`/`to_region_id` filters |
| POST | `/api/driver/orders/accept/{type}/{id}` | attempt to claim an order (type = `taxi` or `delivery`) |
| POST | `/api/driver/orders/complete/{type}/{id}` | mark accepted order as completed |

Acceptance enforces a five‑minute freshness window and checks driver balance/blocked status.

### 3.4 Notifications & feedback
| Method | Path | Notes |
| --- | --- | --- |
| GET | `/api/notifications/` | merges user + driver notifications, newest first |
| GET | `/api/notifications/unread` | unread only |
| POST | `/api/notifications/{id}/mark-read` | mark a single row |
| POST | `/api/notifications/mark-all-read` | bulk mark |
| POST | `/api/feedback/` | send feedback text |

Admin actions (`/api/admin/...`) are only relevant for the dashboard but explain where push events originate (reviewing driver apps, broadcasting, managing pricing).

---

## 4. Domain reference

| Item | Values |
| --- | --- |
| Order types | `taxi`, `delivery` |
| Order statuses | `pending`, `accepted`, `completed`, `cancelled` (the app maps `accepted` → `active`) |
| Driver application statuses | `pending`, `approved`, `rejected` |
| Pricing discounts | Defined per passenger count for taxi, flat price for delivery |
| Notifications | `title`, `message`, `notification_type`, `is_read`, `created_at` |

---

## 5. WebSocket channels

Both channels expect the raw JWT token as the last path segment. Connections are authenticated server side via `get_user_from_token`.

### 5.1 Driver channel
`ws(s)://<base>/ws/driver/{token}`

Events emitted by the server (`type` field):

| Type | Payload | Meaning |
| --- | --- | --- |
| `connected` | `{driver_id, message}` | handshake confirmation |
| `new_order` | `{order: {...}}` | a freshly created taxi/delivery order that is still `pending` |
| `order_accepted` | `{order_id, order_type, driver_id}` | some driver successfully locked the order (remove from other driver lists) |
| `order_completed` | `{order_id, order_type, driver_id}` | completion broadcast (used to clean up active lists) |
| `viewer_count` | `{order_id, count}` | optional crowd indicator |
| `lock_acquired` / `lock_failed` | `{order_id}` | responses to the `request_lock` message a driver can send before accept (not yet used in the UI, but available) |

The client may send:

```json
{"type":"ping"}
{"type":"viewing_order","order_id":123}
{"type":"stop_viewing_order","order_id":123}
{"type":"request_lock","order_id":123}
```

### 5.2 User channel
`ws(s)://<base>/ws/user/{token}`

Events:

| Type | Payload | Meaning |
| --- | --- | --- |
| `connected` | `{user_id, message}` | handshake acknowledgement |
| `order_accepted` | `{order_id, order_type, driver: {...}}` | passenger order obtained a driver; includes driver profile snippet |
| `order_completed` | `{order_id, order_type}` | passenger order finished |
| `driver_status` | `{status, driver_id?, title?, message}` | emitted when an admin approves/rejects the driver application. The message explicitly asks the user to log in again so the UI can refresh. |

---

## 6. Real‑time flow summary

1. **New order** (taxi or delivery)  
   `/api/taxi-orders/` or `/api/delivery-orders/` writes to DB → `manager.broadcast_to_all_drivers` emits `type: "new_order"` → drivers append to their pending list without polling.

2. **Order accepted**  
   `/api/driver/orders/accept/{type}/{id}` sets status to `accepted` →  
   - `manager.broadcast_to_all_drivers`: `{type:"order_accepted", order_id, order_type, driver_id}` so everyone else removes it.  
   - `manager.send_to_user`: `{type:"order_accepted", order_id, order_type, driver:{...}}` so the passenger UI switches to “active” and shows driver info.

3. **Order completed**  
   `/api/driver/orders/complete/{type}/{id}` writes status `completed` → passenger receives `type:"order_completed"` to move the trip into history.

4. **Driver application reviewed**  
   `/api/admin/driver-applications/review` now schedules a WebSocket push via `manager.send_to_user` with `type:"driver_status"` describing whether the application was approved or rejected. The mobile client should refresh `/api/driver/status`, update the local session, and show/queue a notification.

5. **Notifications**  
   Every backend-side event that matters to a user or driver also inserts a row into the `notifications` table. Hitting `/api/notifications/` gives a single merged feed (user scope + driver scope).

---

## 7. Mobile integration checklist

1. **Bootstrap**
   - Login/register, save the token.
   - Call `/api/auth/me`, `/api/regions/`, `/api/regions/{id}/districts`, `/api/driver/status`, `/api/notifications/`.
   - Store the driver status information (`is_driver`, `driver_id`, `application_status`).

2. **Real‑time wiring**
   - Open `ws/user/{token}` for every authenticated session to listen for `order_*` + `driver_status`.
   - Open `ws/driver/{token}` only when `is_driver && driver_approved`.
   - Send periodic `{"type":"ping"}` frames (every ~20–30s) to avoid idle disconnects.
   - When `driver_status` arrives → refresh `/api/driver/status`, refresh notifications, and prompt the user to re-enter driver mode.

3. **Driver dashboard**
   - Use `/api/driver/orders/new` once at entry, then rely on `new_order` / `order_accepted` pushes to keep `_driverAvailableOrders` current.
   - When `order_accepted` arrives for “someone else” → remove that order from the pending list.
   - When it arrives for the current driver → fetch `/api/{taxi|delivery}-orders/{id}` to hydrate full details and move it to the “active” section.

4. **Passenger view**
   - Update local orders immediately after creating them, but also listen for `order_accepted` / `order_completed` WebSocket events to sync status (and driver info) without manual refresh.

5. **Driver application UX**
   - After submitting `/api/driver/apply`, hide the form and show a “pending” state.
   - If a `driver_status` event with `approved` arrives, automatically refresh both the profile and driver dashboard.
   - If `rejected`, reset the “pending” flag so the user can edit/resubmit, and show the rejection reason from the event/notification.

Following this checklist keeps the Flutter app and the FastAPI backend in lockstep without polling-heavy screens.

| Method | Path                    | Description                                                       |
|--------|------------------------|-------------------------------------------------------------------|
| GET    | `/orders/my`           | Query params: `status`, `type`                                    |
| GET    | `/orders/{id}`         | Returns full order (users see their orders, drivers/admins see all) |
| POST   | `/orders/{id}/cancel`  | Body `{ "reason": "..." }`; valid while status is `pending` or `accepted` |

Cancelling an accepted order refunds the driver's service fee and records a transaction.

### 8.4 Ratings

| Method | Path                    | Description                                   |
|--------|------------------------|-----------------------------------------------|
| POST   | `/ratings`             | Body `{ "order_id": 12, "rating": 5, "comment": "Great ride" }` |
| GET    | `/ratings/driver/{id}` | List all ratings for a driver                 |

Only completed orders can be rated once.

### 8.5 Notifications

| Method | Path                         | Description                               |
|--------|------------------------------|-------------------------------------------|
| GET    | `/notifications`             | Optional query `unread=true`               |
| POST   | `/notifications/{id}/read`   | Marks notification as read                |

Notifications include titles, messages, type (e.g. `new_order`), and optional `related_id`.

### 8.6 Feedback

| Method | Path        | Description                         |
|--------|-------------|-------------------------------------|
| POST   | `/feedback` | Body `{ "message": "Add cashback" }`|

Feedback is stored for admins and can be viewed via `/admin/feedback`.

### 8.7 Driver-Specific

| Method | Path                                 | Notes                                                                                |
|--------|--------------------------------------|--------------------------------------------------------------------------------------|
| POST   | `/driver/apply`                      | `multipart/form-data` with `full_name`, `car_model`, `car_number`, `license_image`   |
| GET    | `/driver/profile`                    | Requires driver/admin role                                                          |
| PUT    | `/driver/profile`                    | Update `full_name`, `car_model`, `car_number`                                       |
| GET    | `/driver/orders/new`                 | Filters: `type`, `from_region`, `to_region`; lists pending orders with active deadline |
| POST   | `/driver/orders/{id}/accept`         | Deducts service fee from driver balance if balance >= fee                            |
| POST   | `/driver/orders/{id}/complete`       | Marks accepted order as completed                                                    |
| GET    | `/driver/orders`                     | Lists driver’s orders (`status` filter optional)                                     |
| GET    | `/driver/statistics`                 | Optional `period` (`daily`, `monthly`, `yearly`)                                     |

Accepting an order requires the driver's `balance` to cover the order's `service_fee`. Transactions are created automatically for debits/credits.

### 8.8 Admin & Superadmin (Staff Apps)
These routes are guarded by role middleware. Only include them if the mobile app targets back-office functionality.

| Method | Path                                       | Role            | Purpose                                                |
|--------|--------------------------------------------|-----------------|--------------------------------------------------------|
| GET    | `/admin/driver-applications`               | admin+          | List applications (`status` filter)                    |
| POST   | `/admin/driver-applications/{id}/review`   | admin+          | Body `{ "status": "approved"|"rejected", "rejection_reason": "..." }` |
| GET    | `/admin/drivers`                           | admin+          | Optional `status` filter                               |
| POST   | `/admin/drivers/{id}/add-balance`          | admin+          | Body `{ "amount": 50000 }`                             |
| POST   | `/admin/users/{id}/block`                  | admin+          | Body `{ "is_blocked": true }`                          |
| POST   | `/admin/pricing`                           | admin+          | Manage inter-region pricing                           |
| GET    | `/admin/pricing`                           | admin+          | List pricing entries                                   |
| GET    | `/admin/orders`                            | admin+          | Filters: `status`, `type`, `from_date`, `to_date`     |
| GET    | `/admin/statistics`                        | admin+          | Platform metrics                                       |
| GET    | `/admin/feedback`                          | admin+          | Read user feedback                                     |
| POST   | `/admin/regions`                           | admin+          | Create region                                          |
| PUT    | `/admin/regions/{id}`                      | admin+          | Update region (partial)                                |
| DELETE | `/admin/regions/{id}`                      | admin+          | Delete region                                          |
| POST   | `/admin/districts`                         | admin+          | Create district                                        |
| PUT    | `/admin/districts/{id}`                    | admin+          | Update district (partial)                              |
| DELETE | `/admin/districts/{id}`                    | admin+          | Delete district                                        |
| POST   | `/admin/create-admin`                      | superadmin only | Create new admin user                                  |
| POST   | `/admin/users/{id}/reset-password`         | superadmin only | Body `{ "new_password": "..." }`                       |

---

## 9. File Uploads
- Upload directory defaults to `./uploads` (configurable via `UPLOAD_DIR`).
- Accepted image extensions: `.jpg`, `.jpeg`, `.png`, `.gif`.
- `license_image` and `avatar` uploads store the relative path, which the API returns. Serve them via `/uploads/<relative_path>`.
- Max upload size defaults to 10 MB (`MAX_UPLOAD_SIZE`).

To upload from mobile:
1. Build a multipart request with the file part (`Content-Type: image/jpeg` etc.).
2. Include other form fields as simple text fields.

---

## 10. Pricing & Discounts
- Pricing is managed by admins via `/admin/pricing`.
- Taxi price calculation (`CreateTaxiOrder`):
  1. `base_price + (price_per_person × passenger_count)`
  2. Apply discount from the `discounts` table (per passenger count).
  3. Service fee = percentage of the discounted amount.
  4. Final price = discounted price + service fee.
- Delivery orders reuse the same base pricing with a passenger count of 1.

If pricing is missing for a route, the API returns `400` with `pricing not configured for this route`.

---

## 11. Status & Notification Flow (Driver Orders)
1. **pending** — order created and visible to drivers. Drivers can accept until `accept_deadline` (~5 minutes).
2. **accepted** — assigned to a driver; service fee is deducted and a transaction recorded.
3. **in_progress** — reserved for mid-trip state (not yet exposed).
4. **completed** — driver marks order complete; user can rate driver.
5. **cancelled** — user cancels pending/accepted order. If accepted, driver fee is refunded.

Notifications (`notifications` table) are generated for key events (new orders, application review, etc.) and should be polled periodically by the mobile app.

---

## 12. Environment Configuration Highlights
- `SERVER_HOST`, `SERVER_PORT` determine binding address.
- `JWT_SECRET` must match between backend and any service validating tokens.
- `CORS_ALLOWED_ORIGINS` controls frontend/mobile origins permissible for browsers; native apps can ignore.
- Database credentials (`DB_*`) must be set before startup.

---

## 13. Suggested Integration Checklist
1. **Setup**: Configure base URL per environment, implement HTTP client with JWT header support.
2. **Onboarding**: Implement forms for register/login, handle validation errors surfaced by API.
3. **Localization**: Store and send `language` preference; backend defaults to `uz_latin`.
4. **Location Data**: Cache region/district lists client-side; refresh periodically.
5. **Orders**: Validate input (dates, passenger counts, delivery type) before submission. Display calculated prices returned from API.
6. **Driver Mode**: Gate driver-only screens by role, fetch latest balance/stats on screen entry.
7. **Notifications**: Poll `/notifications` (or set up push once backend supports it); mark read after user interaction.
8. **Error Handling**: Surface `error` messages and watch for `401` / `403` to trigger logout or re-authentication.
9. **File Uploads**: Compress images before upload to stay under 10 MB limit.

---

With this document embedded in your mobile project, an AI or developer can map UI flows to backend capabilities, build test scripts, or wire data bindings with minimal additional context.
